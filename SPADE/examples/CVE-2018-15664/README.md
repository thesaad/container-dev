## CVE-2018-15665 ##
## Symlink Swap to get root acces ##

In this CVE, a function called FollowSymlinkInScope(), used by docker daemon, is vulnerable to TOCTOU(Time To Check To Time Of Use) race attack. When a user tries to copy something into the container filesystem using docker cp, the docker daemon process executes FollowSymlinkInScope() function. This function resolves the path as if the process was inside the container. Once an actual non-symlink path is found, the docker copy command adds this resolved path to the container mount point, and then simply copies. But, an attacker can use the time window after the path resolution and right before the write operation to create a symlink that will be resolved on the host root directory.	Through this exploit, the docker process could potentially overwrite any file on the host due to changes inside the container. A detailed explaination can be found at: https://medium.com/@cpuguy83/docker-symlink-traversal-cve-2018-15664-explained-6bcc715d0a5a


The flow can be re iterated through SPADE's audit reporter. Before that. disp_qos property should be set to lossless under /etc/audit/auditd.conf. And before running the run.sh. SPADE should be started and reporter Audit should be added. 

To that end, there is a simple program provided, the SPADE log for the SPADE run, the Audit log for the program (in skype channel), and the DOT graph for the program. Files with the extension `.gz` can be uncompressed using the command `gunzip <name of the file>`.

## Program ##

The `program` directory contains the the scripts to re-iterate the process. setup.sh sets up the required docker version and then builds the docker image by invoking scrip run_write.sh. run.script starts docker container by passing the targetted to container, container uses symlink_swap binary which keeps on renaming the symlink of the target path and a stashed path inside container, dockerd here resolves the symlinks and if race condition is won by the container's renaming process, the target path is exposed to as container's file system because while resolving symlinks, dockerd uses chroot to make that resolved directory as container's file system. The SymlinkSwap directory contains the Dockerfil and the program which usese syscall to rename symlink path to the stashed path.

* 1-Build: `./setup.sh`
* 2-Run: `./run.sh`


## SPADE Log ##

The file `SPADE_08.25.2021-3.00.01.tar.xz` is a SPADE log (compressed) file which contains the result of detecting crossnaespaces events while spade run. The intial list of crossname space events can be printed using (after extracting):

`grep 'CrossNamespaces event' SPADE_08.25.2021-3.00.01`


## Audit Log ##

Available at: https://github.com/thesaad/container-dev-logs/ under cve-2018-15664.
## query ##
query directory contains the query by simply looking for the paths for w00t_w00t_im_a_flag, and two arbitary files syml1.txt, syml2.txt, being used to track the container's namespaces and process. The lineage here is set to level 5 to get to know connection between our targetted container and the targetted path. 

##Graph ##

The file `Symlink dot.tar.xz` under `graph` directory is the DOT graph for the program above with level 5 to show scenario presented above. It shows all the scenarios. The file symlink svg.targ.gz is the svg version of the same dot graph. It can be seen in the graph that how the win win race is executed by container and then how the processes inside containers are linked between :/var/lib/docker/overlay2/5f33718d4b6a1d5090774f9ce0c5966e1f9540d6036ffc2aa7a54e9ef6b33fc7/merged (which is path of the container) and /w00t_w00t_im_a_flag (which is root path)
